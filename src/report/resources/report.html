<html>
<head>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css"/>

  <script type="text/javascript" src="js/ace-report-viewer.js"></script>
  <script type="text/javascript" src="js/aceReportData.js"></script>
  <script type="text/javascript">

  var aceReportViewer = null;

  function updateTableContents(data) {
    var table = $("#report-table > tbody");
    table.empty();

    data.forEach(function(violation) {
      var tr = $("<tr></tr>");

      var tdImpact = $("<td>" + violation["impact"] + "</td>");
      var tdFile = $("<td>" + violation["file"] + "</td>");
      var tdTarget = $("<td>" + violation["pointer"]["css"] +
        "<br/>" + violation["pointer"]["cfi"] + "</td>");
      var tdRule = $("<td>" + violation["rule"] + "</td>");
      var tdDesc = $("<td>" + violation["desc"] + "</td>");
      var tdLink = $("<td><a href='"
        + violation["kburl"] + "' target='_blank'>"
        + violation["kburl"] + "</a></td>");
      var tdEngine = $("<td>" + violation["engine"] + "</td>");

      tr.append(tdImpact);
      tr.append(tdFile);
      tr.append(tdTarget);
      tr.append(tdRule);
      tr.append(tdDesc);
      tr.append(tdLink);
      tr.append(tdEngine);
      table.append(tr);

    });

  }
  /*function refreshDataTable() {
    $('#report-table').DataTable({
      "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
    });
  }*/

  function filterSelected() {
    var filters = [];
    $("select").each(function(idx, elm) {
      $(elm).children("option").each(function (idx, optElm) {
        if (optElm.selected) {
          filters[elm.name] = optElm.value;
        }
      });
    });

    var filteredData = aceReportViewer.filterViolations(filters);
    updateTableContents(filteredData);
    var filterString = "";
    var isAll = true;
    for (var key in filters) {
      filterString += key + ": " + filters[key];
      if (filters[key] != "all") {
        isAll = false;
      }
    }
    if (isAll) {
      filterString = "Showing all violations";
    }
    else {
      filterString = "Showing violations with <code>" + filterString + "</code>";
    }
    $("#filter-desc").text(filterString);
  }

  function applyMetadata(metadata) {

    $("#pub-title").text(metadata["pubTitle"]);
    $("#pub-identifier").text(metadata["pubIdentifier"]);
    $("#software-name").text(metadata["softwareName"]);
    $("#software-version").text(metadata["softwareVersion"]);
    $("#report-date").text(metadata["reportDate"]);

  }

  function populateFilters(filters) {
    $("#filters").empty();

    filters.forEach(function(filter) {
      $("#filters").append("<span>" + filter.name + "</span>");
      var filterSelect = $("<select name='" + filter.name + "'></select>");
      $("#filters").append(filterSelect);
      filter.values.forEach(function(value) {
        if (value === "all") {
          // preselect 'all'
          filterSelect.append("<option value='all' selected>All</option>");
        }
        else {
          filterSelect.append("<option value='" + value + "'>" + value + "</option>");
        }
      });
    });
    $('select').change(filterSelected);
  }

  $(document).ready(function() {
    aceReportViewer = new AceReport(aceReportData);

    applyMetadata(aceReportViewer.getMetadata());

    // populate filters
    populateFilters(aceReportViewer.getFilters());

    // populate table
    updateTableContents(aceReportViewer.getAllViolations());
    $("#filter-desc").text("Showing all");

    // attach handlers to filters

  });


  </script>




  <title>DAISY Ace Report</title>
</head>
<body>

  <div id="report-metadata">
    <h1>EPUB Accessiblity Report</h1>
    <p>Title: <span id="pub-title"></span></p>
    <p>ID: <span id="pub-identifier"></span></p>
    <p>Generated by: <span id="software-name"></span> (<span id="software-version"></span>) on <span id="report-date"></span></p>
  </div>

  <h1>Violations</h1>
  <p id="filter-desc"></p>
  <p>Filter by:</p>

  <div id="filters">

</div>



  <table id="report-table">
    <thead>
      <tr>
        <td>Impact</td>
        <td>File</td>
        <td>Target</td>
        <td>Rule</td>
        <td>Description</td>
        <td>KB Link</td>
        <td>Engine</td>
      </tr>
    </thead>
    <tbody>
    </tbody>

  </table>


</body>

</html>
